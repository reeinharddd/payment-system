// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- AUTH MODULE ---

model User {
  id        String   @id @default(uuid())
  email     String?  @unique
  phone     String?  @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  identities    UserIdentity[]
  businesses    Business[]        @relation("BusinessOwner")
  employeeProfiles Employee[]
  notifications NotificationLog[]

  @@map("users")
}

model UserIdentity {
  id         String   @id @default(uuid())
  userId     String
  provider   AuthProvider
  providerId String   // email, google_sub, phone_number
  credential String?  // password_hash, null
  metadata   Json?
  lastLogin  DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@map("user_identities")
}

enum AuthProvider {
  LOCAL
  GOOGLE
  PHONE
}

model Employee {
  id          String   @id @default(uuid())
  userId      String?  // Nullable if invite pending
  businessId  String
  branchId    String?  // Nullable if multi-branch or HQ
  roleId      String
  alias       String   // "Juan - Waiter"
  pinCode     String?  // Hashed 4-6 digit PIN
  inviteToken String?  @unique
  status      EmployeeStatus @default(INVITED)
  joinedAt    DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user     User?    @relation(fields: [userId], references: [id])
  business Business @relation(fields: [businessId], references: [id])
  branch   Branch?  @relation(fields: [branchId], references: [id])
  role     Role     @relation(fields: [roleId], references: [id])
  shifts   Shift[]

  @@map("employees")
}

enum EmployeeStatus {
  ACTIVE
  INVITED
  SUSPENDED
}

model Role {
  id          String   @id @default(uuid())
  businessId  String?  // Nullable for System roles
  name        String
  description String?
  type        RoleType @default(CUSTOM)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  business    Business?        @relation(fields: [businessId], references: [id])
  employees   Employee[]
  permissions RolePermission[]

  @@map("roles")
}

enum RoleType {
  SYSTEM
  CUSTOM
}

model Permission {
  id          String   @id @default(uuid())
  action      String   // e.g., "create"
  resource    String   // e.g., "product"
  description String?

  roles RolePermission[]

  @@unique([action, resource])
  @@map("permissions")
}

model RolePermission {
  roleId       String
  permissionId String

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

model ApiKey {
  id         String   @id @default(uuid())
  businessId String
  keyHash    String   @unique
  name       String
  scopes     Json?
  expiresAt  DateTime?
  lastUsedAt DateTime?
  createdAt  DateTime @default(now())

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@map("api_keys")
}

// --- BUSINESS CORE ---

model Business {
  id         String   @id @default(uuid())
  ownerId    String
  legalName  String
  taxId      String   @unique
  country    String   // MX, CO, AR, CL
  industry   String?
  settings   Json?    // Business-wide settings
  fiscalData Json?    // Tax Data
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  owner           User             @relation("BusinessOwner", fields: [ownerId], references: [id])
  branches        Branch[]
  employees       Employee[]
  roles           Role[]
  apiKeys         ApiKey[]
  paymentMethods  PaymentMethod[]
  categories      Category[]
  products        Product[]
  inventoryAlerts InventoryAlert[]
  transactions    Transaction[]
  notificationLogs NotificationLog[]

  @@map("businesses")
}

model Branch {
  id         String   @id @default(uuid())
  businessId String
  name       String
  address    String?
  phone      String?
  timezone   String   @default("UTC")
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  business        Business         @relation(fields: [businessId], references: [id], onDelete: Cascade)
  employees       Employee[]
  stocks          Stock[]
  cashRegisters   CashRegister[]
  inventoryAlerts InventoryAlert[]
  transactions    Transaction[]

  @@map("branches")
}

model PaymentMethod {
  id         String   @id @default(uuid())
  businessId String
  name       String
  type       PaymentMethodType
  config     Json?
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@map("payment_methods")
}

enum PaymentMethodType {
  CASH
  CARD
  QR
  TRANSFER
}

// --- INVENTORY MODULE ---

model Category {
  id          String   @id @default(uuid())
  businessId  String
  parentId    String?
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  business Business   @relation(fields: [businessId], references: [id], onDelete: Cascade)
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")
  products Product[]

  @@map("categories")
}

model Product {
  id             String   @id @default(uuid())
  businessId     String
  categoryId     String?
  name           String
  description    String?
  sku            String?
  barcode        String?  // Unique per Business ideally
  price          Decimal  @db.Decimal(10, 2)
  cost           Decimal  @default(0) @db.Decimal(10, 2)
  taxRate        Decimal  @default(0) @db.Decimal(5, 2)
  type           ProductType @default(ITEM)
  trackInventory Boolean  @default(true)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  business       Business         @relation(fields: [businessId], references: [id], onDelete: Cascade)
  category       Category?        @relation(fields: [categoryId], references: [id])
  variants       Variant[]
  modifierGroups ProductModifierGroup[]
  components     ProductComponent[] @relation("ParentProduct") // As a Pack/Recipe
  componentOf    ProductComponent[] @relation("ChildProduct")  // As an Ingredient/Item
  stocks         Stock[]
  saleItems      SaleItem[]
  inventoryAlerts InventoryAlert[]

  @@unique([businessId, sku])
  @@unique([businessId, barcode])
  @@map("products")
}

enum ProductType {
  ITEM
  SERVICE
  COMPOSITE
}

model ProductComponent {
  id              String   @id @default(uuid())
  parentProductId String
  childProductId  String
  quantity        Decimal  @db.Decimal(10, 4)
  type            ComponentType

  parentProduct Product @relation("ParentProduct", fields: [parentProductId], references: [id], onDelete: Cascade)
  childProduct  Product @relation("ChildProduct", fields: [childProductId], references: [id])

  @@map("product_components")
}

enum ComponentType {
  RECIPE
  PACK
}

model ProductModifierGroup {
  id           String   @id @default(uuid())
  productId    String
  name         String
  minSelection Int      @default(0)
  maxSelection Int      @default(1)
  isRequired   Boolean  @default(false)

  product   Product           @relation(fields: [productId], references: [id], onDelete: Cascade)
  modifiers ProductModifier[]

  @@map("product_modifier_groups")
}

model ProductModifier {
  id              String   @id @default(uuid())
  groupId         String
  name            String
  priceAdjustment Decimal  @default(0) @db.Decimal(10, 2)
  costAdjustment  Decimal  @default(0) @db.Decimal(10, 2)

  group ProductModifierGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@map("product_modifiers")
}

model Variant {
  id        String   @id @default(uuid())
  productId String
  name      String
  sku       String?
  barcode   String?
  price     Decimal  @db.Decimal(10, 2)
  cost      Decimal  @default(0) @db.Decimal(10, 2)

  product   Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  stocks    Stock[]
  saleItems SaleItem[]

  @@map("variants")
}

model Stock {
  id        String   @id @default(uuid())
  branchId  String
  productId String
  variantId String?
  quantity  Decimal  @default(0) @db.Decimal(10, 4)
  minStock  Decimal  @default(0) @db.Decimal(10, 4)
  location  String?
  updatedAt DateTime @updatedAt

  branch  Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
  product Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant Variant? @relation(fields: [variantId], references: [id])

  @@unique([branchId, productId, variantId])
  @@map("stocks")
}

model InventoryAlert {
  id            String   @id @default(uuid())
  businessId    String
  branchId      String
  productId     String
  type          AlertType
  expectedStock Decimal  @db.Decimal(10, 4)
  actualStock   Decimal  @db.Decimal(10, 4)
  status        AlertStatus @default(PENDING)
  createdAt     DateTime @default(now())

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  branch   Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("inventory_alerts")
}

enum AlertType {
  OVERSELLING
  LOW_STOCK
}

enum AlertStatus {
  PENDING
  RESOLVED
}

// --- SALES MODULE ---

model CashRegister {
  id       String   @id @default(uuid())
  branchId String
  name     String
  status   RegisterStatus @default(CLOSED)

  branch Branch  @relation(fields: [branchId], references: [id], onDelete: Cascade)
  shifts Shift[]

  @@map("cash_registers")
}

enum RegisterStatus {
  OPEN
  CLOSED
}

model Shift {
  id             String   @id @default(uuid())
  cashRegisterId String
  employeeId     String
  startTime      DateTime @default(now())
  endTime        DateTime?
  startAmount    Decimal  @db.Decimal(10, 2)
  endAmount      Decimal? @db.Decimal(10, 2)
  expectedAmount Decimal? @db.Decimal(10, 2)
  difference     Decimal? @db.Decimal(10, 2)
  notes          String?

  cashRegister CashRegister @relation(fields: [cashRegisterId], references: [id])
  employee     Employee     @relation(fields: [employeeId], references: [id])
  sales        Sale[]

  @@map("shifts")
}

model Sale {
  id            String   @id @default(uuid())
  shiftId       String?
  customerId    String?  // Link to User if registered customer
  label         String?  // "Table 5", "Tab Name"
  total         Decimal  @db.Decimal(10, 2)
  subtotal      Decimal  @db.Decimal(10, 2)
  tax           Decimal  @db.Decimal(10, 2)
  discount      Decimal  @default(0) @db.Decimal(10, 2)
  status        SaleStatus @default(OPEN)
  channel       SaleChannel @default(POS)
  paymentMethod String?  // Snapshot of method used
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  shift       Shift?       @relation(fields: [shiftId], references: [id])
  items       SaleItem[]
  transaction Transaction?
  invoice     Invoice?

  @@map("sales")
}

enum SaleStatus {
  OPEN
  COMPLETED
  CANCELLED
}

enum SaleChannel {
  POS
  DELIVERY
}

model SaleItem {
  id        String   @id @default(uuid())
  saleId    String
  productId String
  variantId String?
  quantity  Decimal  @db.Decimal(10, 4)
  unitPrice Decimal  @db.Decimal(10, 2)
  total     Decimal  @db.Decimal(10, 2)
  tax       Decimal  @db.Decimal(10, 2)
  discount  Decimal  @default(0) @db.Decimal(10, 2)
  modifiers Json?    // Snapshot of selected modifiers
  notes     String?  // Kitchen notes
  status    ItemStatus @default(PENDING)
  deliveredAt DateTime?

  sale    Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product Product  @relation(fields: [productId], references: [id])
  variant Variant? @relation(fields: [variantId], references: [id])

  @@map("sale_items")
}

enum ItemStatus {
  PENDING
  PREPARING
  READY
  DELIVERED
}

model Transaction {
  id              String   @id @default(uuid())
  businessId      String
  branchId        String?
  saleId          String?  @unique
  amount          Decimal  @db.Decimal(10, 2)
  currency        String
  status          TransactionStatus
  paymentMethod   String
  country         String
  providerAdapter String
  providerData    Json?
  createdAt       DateTime @default(now())
  confirmedAt     DateTime?

  business Business @relation(fields: [businessId], references: [id])
  branch   Branch?  @relation(fields: [branchId], references: [id])
  sale     Sale?    @relation(fields: [saleId], references: [id])
  invoice  Invoice?

  @@map("transactions")
}

enum TransactionStatus {
  PENDING
  CONFIRMED
  FAILED
  REFUNDED
}

// --- BILLING MODULE ---

model Invoice {
  id            String   @id @default(uuid())
  saleId        String?  @unique
  transactionId String?  @unique
  invoiceNumber String   @unique
  type          InvoiceType
  uuid          String?  // Fiscal UUID (Folio Fiscal)
  country       String
  fiscalData    Json?
  pdfUrl        String?
  status        InvoiceStatus
  issuedAt      DateTime @default(now())

  sale        Sale?        @relation(fields: [saleId], references: [id])
  transaction Transaction? @relation(fields: [transactionId], references: [id])

  @@map("invoices")
}

enum InvoiceType {
  INCOME
  EXPENSE
  CREDIT_NOTE
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  CANCELLED
}

// --- NOTIFICATIONS MODULE ---

model NotificationTemplate {
  id        String   @id @default(uuid())
  name      String
  channel   NotificationChannel
  subject   String?
  content   String
  variables Json?
  isActive  Boolean  @default(true)

  @@map("notification_templates")
}

enum NotificationChannel {
  SMS
  EMAIL
  PUSH
  WHATSAPP
}

model NotificationLog {
  id         String   @id @default(uuid())
  businessId String?
  userId     String?
  channel    NotificationChannel
  recipient  String
  status     NotificationStatus @default(PENDING)
  error      String?
  sentAt     DateTime?
  createdAt  DateTime @default(now())

  business Business? @relation(fields: [businessId], references: [id])
  user     User?     @relation(fields: [userId], references: [id])

  @@map("notification_logs")
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
}
